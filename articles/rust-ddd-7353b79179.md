---
title: 'api-server を Rust と DDD で実装する'
emoji: '🦍'
type: 'tech' # tech: 技術記事 / idea: アイデア
topics: [rust, axum, ddd, api]
published: false
---

## TL;DR

rust と フレームワーク axum を使って、api-server を実装してみました。

### 対象読者

- rust で api-server を実装したい人
- DDD に興味がある人

### 説明しないこと

- rust の基本的な文法
- DDD の基本的な考え方

## いざ、実装

### 仕様を決める

今回は、大学が、サークルを管理するシステムを作ることにしました。

- メンバーを追加できる
- メンバーを削除できる
- 4 年生は、追加できない
- 4 年生は、卒業する
- サークルは最低 3 人以上でないと、活動できない
- サークルは、最大人数が決まっている
- サークルには、代表者がいる
- 20 歳以上の人は、飲み会に参加できる
- 3 年生のみ、代表者になれる

### ドメインレイヤー

#### サークル集約

まずは、ドメインレイヤーから作成します。
サークル集約は、集約ルートになる `Circle` と、集約内のメンバーを表す `Member` の 2 つのエンティティから構成されます。

```rust
pub struct Circle {
    pub id: CircleId, // サークルのID (Value Object)
    pub name: String,
    pub capacity: usize,
    pub owner: Member,
    pub members: Vec<Member>,
}
```

```rust
pub struct Member {
    pub id: MemberId, // メンバーのID (Value Object)
    pub name: String,
    pub age: usize,
    pub grade: Grade,
    pub major: Major,
}
```

次に、集約に知識をあたえるために、メソッドを実装します。
rust では `impl` でメソッドを実装します。
※ 簡単のため、エラーは `String` で返していますが、本来は独自のエラー型を作成したほうが良いです。

```rust
impl Circle {
    // サークルの新規作成メソッド
    pub fn new(id: CircleId, name: String, owner: Member, capacity: usize) -> Result<Self, String> {
        // オーナーは3年生のみなれる
        if owner.grade != Grade::Third {
            return Err("Owner must be 3rd grade".to_string());
        }

        Ok(Circle {
            id,
            name,
            owner,
            capacity,
            members: vec![],
        })
    }

    // サークルの再構成メソッド
    pub fn reconstruct(
        id: CircleId,
        name: String,
        owner: Member,
        capacity: usize,
        members: Vec<Member>,
    ) -> Self {
        Circle {
            id,
            name,
            owner,
            capacity,
            members,
        }
    }

    // サークルが満員かどうかを判定するメソッド
    pub fn is_full(&self) -> bool {
        self.members.len() + 1 >= self.capacity
    }

    // サークルが運営可能かどうかを判定するメソッド
    pub fn is_runnable(&self) -> bool {
        self.members.len() + 1 >= 3
    }

    // 飲み会に参加できるかどうかを判定するメソッド
    pub fn is_drinkable_alcohol(member: &Member) -> bool {
        member.is_adult()
    }

    // メンバーをサークルに追加するメソッド
    pub fn add_member(&mut self, member: Member) -> Result<(), String> {
        // 満員の場合はサークルに入れない
        if self.is_full() {
            return Err("Circle member is full".to_string());
        }

        // 4年生はサークルに入れない
        if member.grade == Grade::Fourth {
            return Err("4th grade can't join circle".to_string());
        }

        self.members.push(member);
        Ok(())
    }

    // メンバーをサークルから削除するメソッド
    pub fn remove_member(&mut self, member: &Member) -> Result<(), String> {
        // オーナーは削除できない
        if self.owner.id == member.id {
            return Err("Owner can't be removed".to_string());
        }
        self.members.retain(|m| m.id != member.id);
        Ok(())
    }

    // 4年生を卒業させるメソッド
    pub fn graduate(&mut self) {
        self.members.retain(|m| m.grade != Grade::Fourth);
    }
}
```

```rust
impl Member {
    // メンバーの新規作成メソッド
    pub fn new(id: MemberId, name: String, age: usize, grade: Grade, major: Major) -> Self {
        Member {
            id,
            name,
            age,
            grade,
            major,
        }
    }

    // 20歳以上かどうかを判定するメソッド
    pub fn is_adult(&self) -> bool {
        self.age >= 20
    }
}
```
